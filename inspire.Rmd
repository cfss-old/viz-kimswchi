---
title: "Inspire"
author: "Soo Wan Kim"
date: "April 25, 2017"
output:
  html_document:
    code_folding: hide
    keep_md: true
    theme: default
---

```{r setup, include = FALSE}
library(tidyverse)
library(knitr)
library(plotly)
library(scales)
library(ggthemes)
library(lubridate)
library(knitr)
library(stringr)

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

theme_set(theme_minimal())

hist <- read.csv("Data/inspire_issues.csv") %>%
  rename(Issue = `ï..Issue`)

catalogue <- read.csv("Data/inspire_catalogue.csv") %>%
  rename(Issue = `ï..Issue`) %>%
  transform(Issue = as.double(Issue)) %>%
  transform(NumPages = as.double(NumPages)) %>%
  transform(ItemType = as.character(ItemType)) %>%
  transform(ItemType = ifelse(ItemType %in% c("Poetry", "Photography"), "Art and Poetry", ItemType)) %>%
  transform(ItemType = as.factor(ItemType)) %>%
  transform(ItemType = factor(ItemType, levels = ItemType)) %>%
  transform(AuthorName = as.character(AuthorName)) %>%
  transform(AuthorName = ifelse(AuthorName == "Usama Bin Laden", "Usama bin Laden", AuthorName)) %>%
  transform(AuthorName = ifelse(AuthorName == "AQ Chef", "'AQ Chef'", AuthorName)) %>%
  transform(AuthorName = ifelse(AuthorName == "Terr0r1st", "'Terr0r1st'", AuthorName))
  
#cat$ItemType <- factor(cat$ItemType, levels(cat$ItemType)[cat_type$ItemType])
```

## About

table

```{r about_table}
table <- hist %>%
  select(Issue, CoverStory, ReleaseDate, TotalPages) %>%
  transform(ReleaseDate = as.Date(ReleaseDate, "%m/%d/%y")) %>%
  mutate(ReleaseYear = as.character(year(ReleaseDate))) %>%
  mutate(ReleaseMonth = month.abb[month(ReleaseDate)]) %>%
  transform(ReleaseDate = paste(ReleaseMonth, ReleaseYear)) %>%
  select(-ReleaseYear, -ReleaseMonth) %>%
  transform(CoverStory = as.character(CoverStory)) %>%
  transform(CoverStory = ifelse(Issue == 3, "$4,200", CoverStory))

table %>%
  kable(format = "html", col.names = c("Issue", "Cover Story", "Release Date", "# Pages"))
```

## History

timeline of publication and major events

```{r}
timeline <- read.csv("Data/timeline.csv") %>%
  transform(Date = as.Date(Date, "%m/%d/%Y")) %>%
  transform(Event = as.character(Event)) %>%
  transform(Event = str_replace_all(Event, "<br />", "\n"))

blue <- "#8DB6CD"

ggplot() + 
  geom_segment(aes(x = Date, y = Disp, xend = Date), data = timeline, yend = 0,
               size = 0.08, alpha = 0.5) + 
  geom_segment(aes(x = Date[1] - 75, y = 0, xend = Date[length(Date)] + 75), data = timeline, yend = 0,
               color = blue, size = 1.2) + 
  geom_segment(aes(x = Date[1] - 75, y = -0.08, xend = Date[1] - 75), data = timeline, yend = 0,
               color = blue, size = 1.2) + 
  geom_segment(aes(x = Date[length(Date)] + 75, y = -0.08, 
                   xend = Date[length(Date)] + 75), data = timeline, yend = 0,
               color = blue, size = 1.2) + 
  geom_text(aes(x = Date, y = Disp, label = Event), data = filter(timeline, Inspire == 1),
            vjust = 1) + 
  geom_text(aes(x = Date, y = Disp, label = Event), data = filter(timeline, Offensive == 1),
            vjust = -0.2, size = 3.2) + 
  geom_text(aes(x = Date, y = Disp, label = Event), data = filter(timeline, CT == 1),
            vjust = -0.2, size = 3.2) + 
  annotate(geom = "text", x = as.Date("1/1/2009", "%m/%d/%Y"), 
           y = -0.6, label = "Inspire Publication\n(Issue)", fontface = "bold") +
  annotate(geom = "text", x = as.Date("1/1/2009", "%m/%d/%Y"), 
           y = 0.8, label = "AQAP Offensives", fontface = "bold") +
  annotate(geom = "text", x = as.Date("1/1/2009", "%m/%d/%Y"), 
           y = 2.4, label = "Counter-terror Ops", fontface = "bold") +
  scale_x_date(limits = c(as.Date("5/1/2008", "%m/%d/%Y"), timeline$Date[length(timeline$Date)] + 90),
               date_breaks = "1 year", date_labels = "%Y") + 
  ylim(-1, 3.5) + 
  labs(title = "Timeline of events") + 
  theme_minimal() + 
  theme(axis.title.x = element_blank(),
    axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
    panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())

```

to fix: spacing, font type, etc.

## Content

explanation of different content categories

```{r content_aggregate}
cat_type <- catalogue %>%
  group_by(ItemType) %>%
  summarize(SumPages = sum(NumPages)) %>%
  arrange(desc(SumPages)) %>%
  mutate(TotPages = sum(SumPages)) %>%
  mutate(page_freq_weight = SumPages/TotPages) %>%
  transform(ItemType = as.factor(ItemType)) %>%
  transform(ItemType = factor(ItemType, levels = ItemType))

cat_all <- ggplot(cat_type, aes(ItemType, page_freq_weight)) + 
  geom_point(color = "#5F9F9F") + 
  geom_segment(aes(x = ItemType, y = 0, xend = ItemType, yend = page_freq_weight - 0.005)) + 
  labs(title = "Percentage of articles written for Inspire, by issue",
       x = "Issue", y = "Percentage of articles") + 
  scale_y_continuous(limits = c(0, 0.3), breaks = seq(0, 0.3, .1), labels=percent) + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle = -60, hjust = 0.3))

pcat_all <- plotly_build(cat_all)

pcat_all
```

to fix: add some padding to bottom so labels show up, clean up hover text

by issue

```{r content_by_issue}
cat_issue_type <- catalogue %>%
  group_by(Issue, ItemType) %>%
  summarize(SumPages = sum(NumPages)) %>%
  ungroup()

find_missing_type <- function(issue) {
  data = dplyr::filter(cat_issue_type, Issue == issue)
  TypeList = data$ItemType
  missing = cat_type$ItemType[!cat_type$ItemType %in% TypeList]
  
  return(missing)
}

make_row <- function(issue, missing_type) {
  row = t(as_tibble(c(issue, missing_type, 0)))
  colnames(row) <- c("Issue", "ItemType", "SumPages")
  row = as.data.frame(row)
  rownames(row) <- NULL
  return(row)
}

make_rows <- function(issue) {
  missing = find_missing_type(issue)
  missing_rows = make_row(issue, as.character(missing[1]))
  if (length(missing) > 1) {
    for (x in tail(missing, -1)) {
    missing_rows = rbind(missing_rows, make_row(issue, as.character(x)))
    }
  }
  else {
    missing_rows = missing_rows
  }
  
  return(missing_rows)
}

missing_rows <- make_rows(1)
for (x in seq(2,16)) {
  missing_rows <- rbind(missing_rows, make_rows(x))
}

missing_rows <- missing_rows %>%
  transform(Issue = as.numeric(Issue)) %>%
  transform(SumPages = as.numeric(SumPages) - 1)

cat_issue_type <- rbind(cat_issue_type, missing_rows) %>%
  arrange(Issue) %>%
  na.omit()

TotPages <- catalogue %>%
  group_by(Issue) %>%
  summarize(TotalPages = sum(NumPages))

cat_issue_type <- left_join(cat_issue_type, TotPages) %>%
  mutate(SharePages = SumPages/TotalPages)

rep1 <- cat_issue_type %>%
  transform(Issue = Issue + 0.5)

rep2 <- cat_issue_type %>%
  transform(Issue = Issue + 0.9999)

cat_join <- bind_rows(cat_issue_type, rbind(rep1, rep2)) %>%
  transform(ItemType = as.factor(ItemType)) %>%
  transform(ItemType = factor(ItemType, levels = rev(cat_type$ItemType)))

#ggplot(cat_issue_type, aes(x=Issue, y=SumPages, fill=ItemType)) + 
#  geom_area() + 
#  scale_x_continuous(breaks = seq(1, 16, 1))

#ggplot(cat_issue_type, aes(x=Issue, y=SharePages, fill=ItemType)) + 
#  geom_area(color = "black") + 
#  scale_x_continuous(breaks = seq(1, 16, 1))

cat_issue <- ggplot(cat_join, aes(x=Issue, y=SharePages, fill=ItemType)) + 
  geom_area(color = "white") + 
  scale_x_continuous(breaks = seq(1.5, 16.5, 1), labels = seq(1, 16, 1)) + 
  scale_y_continuous(labels = percent_format()) + 
  labs(title = "Share of pages per category, by issue",
       x = "Issue", y = "Percentage of total",
       fill = "Category") + 
  scale_fill_ptol() + 
  theme_classic()

pcat_issue <- plotly_build(cat_issue)

pcat_issue
```

to fix: inaccurate labels when mouse hovers over

## Authorship

```{r original_content}
original <- catalogue %>%
  filter(!is.na(OriginalContent)) %>%
  group_by(Issue, OriginalContent) %>%
  summarize(orig_freq = n())

original_n <- catalogue %>%
  filter(!is.na(OriginalContent)) %>%
  group_by(Issue) %>%
  summarize(tot_num = n())

original <- left_join(original, original_n, by = "Issue") %>%
  mutate(orig_freq_weight = orig_freq/tot_num) %>%
  arrange(OriginalContent) %>%
  transform(OriginalContent = ifelse(OriginalContent == 0, "No", "Yes")) %>%
  transform(OriginalContent = as.factor(OriginalContent)) %>%
  transform(OriginalContent = factor(OriginalContent, levels = OriginalContent))

orig <- ggplot(original, aes(Issue, orig_freq_weight)) + 
  geom_bar(aes(fill = OriginalContent), stat = "identity") + 
  labs(title = "Percentage of articles written for article, by issue",
       x = "Issue", y = "Percentage of articles",
       fill = "Original Content?") + 
  scale_fill_manual(values = c("#4B0082", "#FFD700")) + 
  scale_x_continuous(breaks = seq(1, 16, 1)) + 
  scale_y_continuous(labels = percent_format()) + 
  theme_classic() + 
  theme(axis.ticks.x = element_blank())

porig <- plotly_build(orig)

porig
```

to fix: clean up hover labels

```{r authors_num}
authors_all_issues <- catalogue %>%
  filter(!is.na(AuthorName) & !AuthorName %in% c("Various", 
                                                "Al-Qaeda in the Arabian Peninsula",
                                                "Al-Malahem",
                                                "External Operations Team",
                                                "Reconaissance Team",
                                                "Experts")) %>%
  count(AuthorName) %>%
  arrange(n) %>%
  filter(n >= 3) %>%
  transform(AuthorName = as.factor(AuthorName)) %>%
  transform(AuthorName = factor(AuthorName, levels = AuthorName))
```

`r nrow(authors_all_issues)` (presumably) individual authors

```{r authors_chart}
author_info <- read.csv("Data/author_info.csv", colClasses = c("factor", "character"))

authors <- ggplot(authors_all_issues, aes(n, AuthorName)) + 
  geom_point(color = "#FF6347") + 
  geom_segment(aes(x = 0, y = AuthorName, xend = n-0.05, yend = AuthorName)) +
  scale_x_continuous(breaks = seq(3, 11, 2)) + 
  labs(title = "Inspire Magazine: most featured authors",
       x = "Number of times featured",
       y = "") + 
  theme_minimal() + 
  theme(plot.title = element_text(size = 14),
        axis.title = element_text(size = 12),
        panel.grid.minor = element_blank())

pauthors <- plotly_build(authors)

pauthors$x$data[[1]]$text <- author_info$X
pauthors$x$data[[2]]$text <- ""
pauthors
```

to fix: make hover text neater - make text bubbles more uniform in width
